# APP设计文档

## 概述

本文档基于后端API接口设计，为移动应用（Flutter）和Web应用提供完整的功能规划和界面设计方案。涵盖用户认证、文件管理、家族树、活动管理、应用版本、IPTV、消息中心、地图轨迹、TV频道、验证码等10个核心功能模块。

## 系统架构

### 技术栈
- **后端**: Spring Boot + MySQL + Redis
- **移动端**: Flutter (支持iOS/Android)
- **Web端**: Vue.js/React
- **文件存储**: 本地文件系统
- **认证方式**: JWT Token

### 基础信息
- **API基础路径**: `http://localhost:8080`
- **认证方式**: Bearer Token
- **响应格式**: 统一JSON格式

## 功能模块设计

### 1. 用户认证模块

#### 功能清单
- 用户注册（邮箱验证）
- 用户登录（支持验证码）
- 密码重置
- Token刷新
- 用户信息管理

#### 核心API接口
- **注册**: `POST /register`
- **登录**: `POST /login`
- **获取用户信息**: `GET /profile`
- **更新用户信息**: `POST /updateUserInfo`
- **重置密码**: `POST /resetPassword`
- **Token刷新**: `POST /refreshToken`
- **获取验证码**: `GET /captcha?requestId={id}`
- **发送邮箱验证码**: `POST /sendEmailCaptcha`

#### 界面设计

##### 登录页面
┌─────────────────────────────┐
│         应用Logo            │
│                            │
│  ┌───────────────────────┐  │
│  │   邮箱/用户名          │  │
│  └───────────────────────┘  │
│  ┌───────────────────────┐  │
│  │      密码             │  │
│  └───────────────────────┘  │
│  ┌───────────────────────┐  │
│  │   验证码（如需）       │  │
│  └───────────────────────┘  │
│  ┌───────────────────────┐  │
│  │       登录            │  │
│  └───────────────────────┘  │
│                            │
│  忘记密码？    立即注册     │
└─────────────────────────────┘


### 2. 文件管理模块

#### 功能清单
- 文件上传（最大100MB）
- 文件列表（分页，支持搜索）
- 文件下载
- 文件删除
- 文件信息查询

#### 核心API接口
- **文件上传**: `POST /file/upload`
- **文件列表**: `GET /file/list?page={page}&size={size}&keyword={keyword}`
- **文件下载**: `GET /file/download/{fileName}`
- **文件信息**: `GET /file/info/{fileId}`
- **文件删除**: `DELETE /file/delete/{fileId}`

#### 界面设计

##### 文件列表页面
┌─────────────────────────────┐
│ 文件管理          [上传]    │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索文件名...        │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────┬────┐ │
│ │文件名│文件大小 │时间 │操作│ │
│ ├─────┼─────────┼─────┼────┤ │
│ │文档1│ 2.5MB   │今天 │[下载]│
│ │图片1│ 1.2MB   │昨天 │[删除]│
│ │视频1│ 15.3MB  │2天前│[下载]│
│ └─────┴─────────┴─────┴────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共3页 [下一页→] │
└─────────────────────────────┘


### 3. 家族树模块

#### 功能清单
- 家族成员管理（增删改查）
- 家族关系维护（添加、删除关系）
- 家族树可视化（支持多代展示）
- 成员搜索（支持关键词）
- 关系认证管理（验证家族关系的真实性）
- 模拟数据生成（用于测试和演示）

#### 数据模型

##### FamilyMember（家族成员）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | Long | 成员ID（主键） |
| name | String | 成员姓名 |
| avatar | String | 成员头像URL |
| gender | Gender | 性别（枚举：MALE, FEMALE） |
| birthDate | LocalDate | 出生日期 |
| birthPlace | String | 出生地点 |
| occupation | String | 职业 |
| education | String | 教育程度 |
| contactInfo | String | 联系方式 |
| deceased | boolean | 是否已去世 |
| deathDate | LocalDate | 去世日期 |
| generation | Integer | 代际数 |

##### FamilyRelationship（家族关系）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | Long | 关系ID（主键） |
| member1 | FamilyMember | 关系成员1 |
| member2 | FamilyMember | 关系成员2 |
| type | RelationshipType | 关系类型 |
| verificationStatus | VerificationStatus | 认证状态（默认PENDING） |
| startDate | LocalDate | 关系开始日期 |
| endDate | LocalDate | 关系结束日期 |

##### RelationshipType（关系类型枚举）
- PARENT_CHILD：父子
- SPOUSE：夫妻
- SIBLING：兄弟姐妹
- GRANDPARENT_GRANDCHILD：祖孙
- FATHER：父亲
- MOTHER：母亲
- SON：儿子
- DAUGHTER：女儿
- HUSBAND：丈夫
- WIFE：妻子
- BROTHER：兄弟
- SISTER：姐妹
- GRANDFATHER：祖父
- GRANDMOTHER：祖母
- GRANDSON：孙子
- GRANDDAUGHTER：孙女
- UNCLE：叔叔/伯父
- AUNT：阿姨/姑姑
- NEPHEW：侄子
- NIECE：侄女
- OTHER：其他

#### 核心API接口
- **添加成员**: `POST /family/members/add` - 添加新的家族成员
- **获取成员**: `GET /family/members/{id}` - 获取指定ID的成员详情
- **删除成员**: `POST /family/members/delete` - 删除指定ID的成员及其所有关系
- **添加关系**: `POST /family/relationships` - 添加两个成员之间的关系
- **删除关系**: `POST /family/relationships/delete` - 删除指定ID的成员关系
- **获取家族树**: `GET /family/tree/{rootId}?generations={n}` - 获取以指定成员为根的家族树，默认显示3代
- **搜索成员**: `GET /family/members/query?keyword={keyword}&page={page}&size={size}` - 按关键词搜索家族成员
- **生成模拟数据**: `POST /family/save/mock` - 生成模拟家族树数据用于测试

#### 业务逻辑

1. **成员管理**
   - 添加成员时验证必填字段（姓名、代际数）
   - 删除成员时自动删除与其相关的所有关系
   - 支持按关键词模糊搜索成员

2. **关系管理**
   - 添加关系时验证两个成员是否存在
   - 检查时间顺序（开始日期≤结束日期）
   - 检测环形关系，避免无限循环
   - 新添加的关系默认处于"待认证"状态

3. **家族树构建**
   - 以指定成员为根节点，递归查询关联成员
   - 默认限制最大查询代数为3代，可通过参数调整
   - 构建树形数据结构，包含成员信息和关系类型
   - 去重处理，避免重复节点

#### 界面设计

##### 家族树页面
┌─────────────────────────────┐
│ 家族树          [添加成员]  │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索成员...          │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│        家族树可视化区域      │
│                             │
│     祖父 → 祖母            │
│         ↓                   │
│      父亲 → 母亲            │
│         ↓                   │
│        本人 → 配偶          │
│         ↓                   │
│       子女                 │
├─────────────────────────────┤
│ [←返回]  [放大] [缩小] [导出] │
└─────────────────────────────┘

##### 成员详情页面
┌─────────────────────────────┐
│ 成员详情          [编辑]     │
├─────────────────────────────┤
│ ┌─────────┐                 │
│ │ 头像    │ 姓名：张三       │
│ └─────────┘ 性别：男         │
│              出生日期：1980-01-01 │
│              职业：工程师     │
│              教育程度：本科   │
│ ┌───────────────────────┐    │
│ │ 关系列表：             │    │
│ │ 父亲：李四             │    │
│ │ 母亲：王五             │    │
│ │ 配偶：赵六             │    │
│ │ 子女：张小一、张小二   │    │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ [←返回]  [删除]  [添加关系]   │
└─────────────────────────────┘

##### 成员管理页面
┌─────────────────────────────┐
│ 成员管理          [添加]     │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索：__________      │ 🔍 │
│ ├───────────────────────┤    │
│ │ 筛选：性别 [全部]     │    │
│ │       代际 [全部]     │    │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ 序号  姓名    性别  代际  操作  │
│ ───────────────────────────── │
│ 1    张三     男    3    [详情] │
│ 2    李四     男    2    [详情] │
│ 3    王五     女    2    [详情] │
│ 4    赵六     女    3    [详情] │
│ 5    张小一    男    4    [详情] │
├─────────────────────────────┤
│ [←上一页] 1/3 [下一页→]      │
└─────────────────────────────┘

##### 关系管理页面
┌─────────────────────────────┐
│ 关系管理          [添加]     │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索：__________      │ 🔍 │
│ ├───────────────────────┤    │
│ │ 筛选：关系类型 [全部]  │    │
│ │       认证状态 [全部]  │    │
│ └─────────────────────────┘  │
├─────────────────────────────┤
│ 成员1   关系   成员2   认证状态 │
│ ───────────────────────────── │
│ 张三    父亲   李四    已认证   │
│ 张三    母亲   王五    已认证   │
│ 张三    配偶   赵六    待认证   │
│ 李四    配偶   王五    已认证   │
│ 张三    父亲   张小一   待认证   │
├─────────────────────────────┤
│ [←上一页] 1/2 [下一页→]      │
└─────────────────────────────┘


### 4. 活动管理模块

#### 功能清单
- 活动创建
- 活动列表（分页）
- 活动详情查看
- 模拟数据生成

#### 核心API接口
- **获取活动列表**: `GET /activities?page={page}&size={size}`
- **创建活动**: `POST /activities`
- **生成模拟数据**: `GET/POST /activities/mock`

#### 界面设计

##### 活动列表页面
┌─────────────────────────────┐
│ 活动管理          [创建]    │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索活动...          │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────┬────┐ │
│ │活动名│开始时间 │状态 │操作│ │
│ ├─────┼─────────┼─────┼────┤ │
│ │活动1│ 2024-05-10 │进行中│[查看]│
│ │活动2│ 2024-05-15 │已结束│[查看]│
│ │活动3│ 2024-05-20 │未开始│[查看]│
│ └─────┴─────────┴─────┴────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共3页 [下一页→] │
└─────────────────────────────┘


### 5. 应用版本管理模块

#### 功能清单
- 文件上传与版本保存
- 文件下载
- 版本更新检查
- 版本列表查询
- 文件访问

#### 核心API接口
- **文件上传**: `POST /app/upload`
- **文件下载**: `GET /app/download/{fileId}`
- **版本检查**: `GET /app/check?currentVersion={version}`
- **文件访问**: `GET /app/files/{fileName}`
- **版本列表**: `GET /app/versions?page={page}&size={size}&keyword={keyword}`

#### 界面设计

##### 版本管理页面
┌─────────────────────────────┐
│ 版本管理          [上传]    │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索版本...          │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────┬────┐ │
│ │版本号│发布日期 │状态 │操作│ │
│ ├─────┼─────────┼─────┼────┤ │
│ │2.1.0│2024-05-10│最新 │[下载]│
│ │2.0.0│2024-04-15│可下载│[下载]│
│ │1.9.0│2024-03-20│可下载│[下载]│
│ └─────┴─────────┴─────┴────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共2页 [下一页→] │
└─────────────────────────────┘


### 6. IPTV模块

#### 功能清单
- IPTV频道列表（分页，支持分类和关键词）
- 频道数据重新加载
- 按标签查询频道
- 按分组查询频道
- 收藏频道管理
- 收藏频道列表

#### 核心API接口
- **频道列表**: `POST /iptv/channels`
- **重新加载**: `POST /iptv/reload`
- **按标签查询**: `POST /iptv/query/tags`
- **按分组查询**: `POST /iptv/query/group`
- **添加收藏**: `POST /iptv/favorite/add/{channelId}`
- **删除收藏**: `POST /iptv/favorite/remove/{channelId}`
- **收藏列表**: `POST /iptv/favorite/list`

#### 界面设计

##### IPTV频道列表页面
┌─────────────────────────────┐
│ IPTV频道          [刷新]    │
├─────────────────────────────┤
│ ┌────────┬────────┬───────┐ │
│ │全部    │电影    │综艺   │ │
│ │体育    │新闻    │其他   │ │
│ └────────┴────────┴───────┘ │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索频道...          │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────┬────┐ │
│ │频道名│分组    │分类 │操作│ │
│ ├─────┼─────────┼─────┼────┤ │
│ │电影频道│娱乐   │电影 │[播放][收藏]│
│ │新闻频道│新闻   │新闻 │[播放][收藏]│
│ │体育频道│体育   │体育 │[播放][收藏]│
│ └─────┴─────────┴─────┴────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共5页 [下一页→] │
└─────────────────────────────┘


### 7. 消息中心模块

#### 功能清单
- 发送消息
- 发送邮件消息
- 标记消息为已读
- 删除消息
- 查询消息列表（支持筛选和分页）

#### 核心API接口
- **发送消息**: `GET /message/send?receiverId={id}&content={content}`
- **发送邮件**: `GET /message/sendEmail?receiverEmail={email}&content={content}`
- **标记已读**: `GET /message/{id}/read`
- **删除消息**: `GET /message/{id}`
- **查询列表**: `POST /message/query`

#### 界面设计

##### 消息列表页面
┌─────────────────────────────┐
│ 消息中心          [新消息]   │
├─────────────────────────────┤
│ ┌────────┬──────────────────┐ │
│ │全部    │未读消息         │ │
│ └────────┴──────────────────┘ │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────┬─────┐ │
│ │发送者│时间    │状态 │操作  │ │
│ ├─────┼─────────┼─────┼─────┤ │
│ │张三  │今天 10:30│未读 │[查看][删除]│
│ │李四  │昨天 14:20│已读 │[查看][删除]│
│ │王五  │2天前 09:15│已读 │[查看][删除]│
│ └─────┴─────────┴─────┴─────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共4页 [下一页→] │
└─────────────────────────────┘


### 8. 地图轨迹模块

#### 功能清单
- 轨迹数据保存
- 轨迹列表查询（分页，支持时间区间筛选）

#### 核心API接口
- **保存轨迹**: `POST /trajectorys/save`
- **查询轨迹**: `GET /trajectorys/query?page={page}&size={size}&startTime={time1}&endTime={time2}`

#### 界面设计

##### 轨迹列表页面
┌─────────────────────────────┐
│ 地图轨迹          [记录轨迹] │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 选择时间区间...       │ 📅 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ [地图可视化区域]             │
│                             │
│ 📍 长宁区仙霞路 (10:30)      │
│ 📍 长宁区延安西路 (11:15)    │
│                             │
├─────────────────────────────┤
│ ┌─────┬─────────┬─────────────┐ │
│ │序号 │时间    │地址         │ │
│ ├─────┼─────────┼─────────────┤ │
│ │1    │10:30   │长宁区仙霞路  │ │
│ │2    │11:15   │长宁区延安西路│ │
│ │3    │12:00   │静安区南京西路│ │
│ └─────┴─────────┴─────────────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共2页 [下一页→] │
└─────────────────────────────┘


### 9. TV频道模块

#### 功能清单
- TV频道列表（分页）
- TV频道搜索（支持关键词）

#### 核心API接口
- **获取频道**: `GET /tv?page={page}&size={size}`
- **搜索频道**: `GET /tv/search?keyword={keyword}&page={page}&size={size}`

#### 界面设计

##### TV频道页面
┌─────────────────────────────┐
│ TV频道          [搜索]      │
├─────────────────────────────┤
│ ┌───────────────────────┐    │
│ │ 搜索频道...          │ 🔍 │
│ └───────────────────────┘    │
├─────────────────────────────┤
│ ┌─────────┬────────┬───────┐ │
│ │频道名称 │信号源数│操作   │ │
│ ├─────────┼────────┼───────┤ │
│ │CCTV 1   │1个信号源 │[播放]│
│ │CCTV 5   │2个信号源 │[播放]│
│ │湖南卫视 │1个信号源 │[播放]│
│ └─────────┴────────┴───────┘ │
├─────────────────────────────┤
│ [←上一页] 第1页/共5页 [下一页→] │
└─────────────────────────────┘


### 10. 验证码模块

#### 功能清单
- 获取图形验证码
- 验证验证码（内部使用）
- 邮箱验证码管理（内部使用）

#### 核心API接口
- **获取验证码**: `GET /captcha?requestId={id}`

#### 界面设计

##### 验证码使用场景
验证码主要在以下场景中使用：
- 用户登录页面（可选）
- 用户注册页面
- 密码重置页面
- 敏感操作确认

##### 验证码显示示例
┌───────────────────────┐
│ 验证码：[______]      │
│ [验证码图片]    [刷新] │
└───────────────────────┘


## 数据模型

### 用户相关
- **User**: 用户基本信息
- **UserToken**: 用户认证令牌

### 文件相关
- **FileInfo**: 文件信息

### 家族树相关
- **FamilyMember**: 家族成员
- **FamilyRelationship**: 家族关系

### 活动相关
- **Activity**: 活动信息

### 应用版本相关
- **AppVersion**: 应用版本信息

### IPTV相关
- **IptvChannel**: IPTV频道
- **UserFavoriteChannel**: 用户收藏频道

### 消息相关
- **MessageItem**: 消息内容

### 地图轨迹相关
- **Trajectory**: 轨迹数据

### TV频道相关
- **TvChannel**: TV频道
- **ChannelUrl**: 频道信号源

### 验证码相关
- **CaptchaInfo**: 验证码信息

## 技术规范

### 接口规范
- 所有接口使用RESTful风格
- 统一响应格式：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": { ... },
    "total": null,
    "page": null,
    "size": null
  }
  ```
- 认证方式：Bearer Token（除公开接口外）

### 安全规范
- 密码加密存储
- 敏感数据传输加密
- Token有效期管理
- 请求频率限制

### 性能规范
- 分页查询默认每页10条数据
- 文件上传限制100MB
- 响应时间要求：90%的请求在1秒内返回

## 开发计划

### 第一阶段：基础架构搭建
- 项目初始化
- 用户认证模块
- 基础UI组件

### 第二阶段：核心功能实现
- 文件管理模块
- 家族树模块
- 活动管理模块

### 第三阶段：扩展功能实现
- 应用版本管理
- IPTV模块
- 消息中心模块

### 第四阶段：完善与优化
- 地图轨迹模块
- TV频道模块
- 验证码模块
- 性能优化
- 测试与修复

## 测试计划

### 单元测试
- 各功能模块的核心逻辑测试
- API接口参数验证
- 数据模型验证

### 集成测试
- 模块间接口调用测试
- 前后端对接测试

### 性能测试
- 大量数据下的分页查询性能
- 文件上传下载速度测试
- 并发请求处理能力

## 部署方案

### 后端部署
- 使用Docker容器化部署
- 支持水平扩展
- 配置Nginx反向代理

### 移动端部署
- iOS: App Store
- Android: Google Play + 应用市场

### Web端部署
- 静态文件CDN加速
- 容器化部署

## 文档维护

- 文档版本：v1.0
- 最后更新：2024-05-20
- 更新记录：
  - 2024-05-20：初始版本，包含所有API模块

## 附录

### API基础路径
- 开发环境：`http://localhost:8080`
- 测试环境：`http://test.example.com`
- 生产环境：`http://api.example.com`

### 错误码说明
- `200`: 成功
- `400`: 请求参数错误
- `401`: 未授权
- `403`: 禁止访问
- `404`: 资源不存在
- `500`: 服务器内部错误