# 熔断与限流

## 目录

- [熔断与限流](#熔断与限流)
  - [目录](#目录)
  - [1. 基础概念](#1-基础概念)
  - [2. 限流算法](#2-限流算法)
  - [3. Sentinel](#3-哨兵)
    - [3.1 背景介绍](#31-背景介绍)
    - [3.2 整体架构](#32-整体架构)
    - [3.3 核心组件](#33-核心组件)
    - [3.4 常用类](#34-常用类)
    - [3.5 流控规则](#35-流控规则)
    - [3.6 熔断降级](#36-熔断降级)
    - [3.7 系统保护](#37-系统保护)
    - [3.8 自定义插槽](#38-自定义插槽)
    - [3.9 分布式限流](#39-分布式限流)
  - [4. Hystrix](#4-豪猪)
  - [5. Resilience4j](#5-弹性4j)
  - [6. 三种框架对比](#6-三种框架对比)
  - [7. 面试题解析](#7-面试题解析)
  - [8. 参考链接](#8-参考链接)

## 1. 基础概念

在分布式系统中，熔断和限流是保护系统稳定性的重要手段：

- **限流**：控制单位时间内的请求数量，防止系统被过载
- **熔断**：当服务出现故障时，快速失败并拒绝请求，避免级联故障
- **降级**：当系统负载过高时，关闭一些非核心功能，保证核心功能的正常运行

## 2. 限流算法

### 1. 计数器算法
- **原理**：维护一个计数器，单位时间内计数，超过阈值则拒绝请求
- **优点**：实现简单
- **缺点**：存在边界效应

### 2. 固定窗口算法
- **原理**：将时间划分为固定窗口，每个窗口内维护计数器
- **优点**：实现简单
- **缺点**：存在边界效应

### 3. 滑动窗口算法
- **原理**：将时间划分为多个小窗口，滑动计算窗口内的请求数
- **优点**：解决了边界效应
- **缺点**：实现相对复杂

### 4. 令牌桶算法
- **原理**：系统以恒定速率向桶中放入令牌，请求需要获取令牌才能通过
- **优点**：平滑限流，支持突发流量
- **缺点**：参数配置复杂

### 5. 漏桶算法
- **原理**：请求进入漏桶，漏桶以恒定速率处理请求
- **优点**：平滑限流
- **缺点**：不支持突发流量

## 3. Sentinel

### 3.1 背景介绍

Sentinel 是阿里巴巴开源的流量控制、熔断降级框架：

- 2012年诞生于阿里巴巴
- 2018年开源
- 主要功能：流量控制、熔断降级、系统保护、热点参数限流等

### 3.2 整体架构

Sentinel 的核心是一个**插槽链**（Slot Chain），请求会依次通过各个插槽进行处理：

1. **NodeSelectorSlot**：构建资源调用树
2. **ClusterBuilderSlot**：存储资源统计信息
3. **StatisticSlot**：记录、统计监控指标
4. **FlowSlot**：流量控制
5. **AuthoritySlot**：黑白名单控制
6. **DegradeSlot**：熔断降级
7. **SystemSlot**：系统保护

### 3.3 核心组件

- **NodeSelectorSlot**：负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级
- **ClusterBuilderSlot**：用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等，这些信息将用作为多维度限流，降级的依据
- **StatisticSlot**：用于记录、统计不同纬度的 runtime 指标监控信息
- **FlowSlot**：用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制
- **AuthoritySlot**：根据配置的黑白名单和调用来源信息，来做黑白名单控制
- **DegradeSlot**：通过统计信息以及预设的规则，来做熔断降级
- **SystemSlot**：通过系统的状态，例如 load1 等，来控制总的入口流量

### 3.4 常用类

- **Entry**：表示一个请求的入口，包含请求的上下文信息和流量控制策略
- **Resource**：表示一个请求的资源，可以是 URL、方法、服务等
- **Rule**：表示一个流量控制规则，包含资源、流量控制模式、阈值等信息
- **SlotChain**：表示一个拦截器链，用于对请求进行拦截和处理
- **ProcessorSlot**：表示一个拦截器或处理器，用于对请求进行处理和转发
- **SphU**：入口工具类，用于创建 Entry 对象和进行流量控制
- **Tracer**：请求追踪器，用于记录请求的上下文信息和状态

### 3.5 流控规则

#### 流控模式

1. **直接**：统计当前资源的请求，触发阈值时对当前资源直接限流
2. **关联**：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流
3. **链路**：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流

#### 流控效果

1. **快速失败**：达到阈值后，新的请求会被立即拒绝并抛出 FlowException 异常
2. **Warm Up**：预热模式，阈值从较小值逐渐增加到最大阈值
3. **排队等待**：所有请求按照先后次序排队执行，两个请求的间隔不能小于指定时长

#### 限流类型

1. **QPS 限流**：基于每秒请求数进行限流
2. **线程数限流**：基于并发线程数进行限流

### 3.6 熔断降级

#### 熔断策略

1. **慢调用比例**：当单位统计时长内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则触发熔断
2. **异常比例**：当单位统计时长内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则触发熔断
3. **异常数**：当单位统计时长内的异常数目超过阈值之后会触发熔断

#### 熔断状态

1. **OPEN**：熔断开启，拒绝所有请求
2. **HALF_OPEN**：探测恢复状态，允许一个请求尝试，如果成功则关闭熔断，否则继续熔断
3. **CLOSED**：熔断关闭，请求正常通过

### 3.7 系统保护

Sentinel 系统保护规则是从整体维度对应用入口流量进行控制，主要包括：

- **Load 自适应**：系统 load1 超过阈值，且并发线程数超过系统容量时触发
- **CPU 使用率**：当系统 CPU 使用率超过阈值时触发
- **平均 RT**：当所有入口流量的平均 RT 超过阈值时触发
- **入口 QPS**：当所有入口流量的 QPS 超过阈值时触发
- **并发线程数**：当所有入口流量的并发线程数超过阈值时触发

### 3.8 自定义插槽

Sentinel 将 ProcessorSlot 作为 SPI 接口进行扩展，使得 Slot Chain 具备了扩展的能力。您可以自行加入自定义的 slot 并编排 slot 间的顺序，从而可以给 Sentinel 添加自定义的功能。

### 3.9 分布式限流

Sentinel 支持集群限流，主要有两种模式：

1. **集群流控服务**：独立部署的流控服务，负责计算集群总流量并分发配额
2. **嵌入式**：在应用内部集成集群流控模块

## 4. Hystrix

Hystrix 是 Netflix 开源的熔断降级框架，现已进入维护模式：

### 核心特性

- **熔断**：当服务出现故障时，快速失败并拒绝请求
- **隔离**：通过线程池或信号量隔离不同服务的调用
- **降级**：当服务不可用时，返回降级响应
- **缓存**：支持请求缓存，减少重复调用
- **监控**：提供实时监控和告警

### 工作原理

1. **命令模式**：将服务调用封装为 HystrixCommand
2. **执行**：在独立线程池中执行命令
3. **监控**：实时监控命令执行状态
4. **熔断**：当失败率超过阈值时，触发熔断
5. **降级**：熔断时执行降级逻辑

## 5. Resilience4j

Resilience4j 是一个轻量级的熔断降级框架，专为 Java 8 和函数式编程设计：

### 核心模块

- **CircuitBreaker**：熔断
- **RateLimiter**：限流
- **Retry**：重试
- **Bulkhead**：隔离
- **Timeout**：超时
- **Cache**：缓存

### 优点

- **轻量级**：仅依赖 Vavr，无其他外部依赖
- **函数式编程**：支持 Java 8 Lambda 表达式
- **模块化**：可以只引入需要的模块
- **扩展性**：易于与其他框架集成

## 6. 三种框架对比

| 特性 | Sentinel | Hystrix | Resilience4j |
|------|---------|---------|-------------|
| 开发团队 | 阿里巴巴 | Netflix | Resilience4j Team |
| 状态 | 活跃维护 | 维护模式 | 活跃维护 |
| 隔离策略 | 信号量 | 线程池/信号量 | 信号量 |
| 熔断策略 | 慢调用比例、异常比例、异常数 | 错误百分比 | 错误百分比、慢调用比例 |
| 限流算法 | 计数器、滑动窗口 | 线程池大小 | 基于信号量 |
| 分布式支持 | 支持 | 有限支持 | 有限支持 |
| 监控 | 控制台 | Dashboard | Micrometer 集成 |
| 易用性 | 简单 | 复杂 | 简单 |
| 性能 | 高 | 中 | 高 |

## 7. 面试题解析

### 1. 什么是熔断？为什么需要熔断？

**答案**：
- **熔断**：当服务出现故障时，快速失败并拒绝请求，避免级联故障的一种保护机制。
- **原因**：在分布式系统中，服务之间存在依赖关系，当某个服务出现故障时，如果继续调用该服务，可能会导致调用方也出现故障，最终导致整个系统崩溃（级联故障）。熔断机制可以在服务出现故障时，快速失败并拒绝请求，给故障服务时间恢复，从而保护整个系统的稳定性。

### 2. 什么是限流？常见的限流算法有哪些？

**答案**：
- **限流**：控制单位时间内的请求数量，防止系统被过载的一种保护机制。
- **常见限流算法**：
  1. **计数器算法**：维护一个计数器，单位时间内计数，超过阈值则拒绝请求
  2. **固定窗口算法**：将时间划分为固定窗口，每个窗口内维护计数器
  3. **滑动窗口算法**：将时间划分为多个小窗口，滑动计算窗口内的请求数
  4. **令牌桶算法**：系统以恒定速率向桶中放入令牌，请求需要获取令牌才能通过
  5. **漏桶算法**：请求进入漏桶，漏桶以恒定速率处理请求

### 3. Sentinel 的核心组件有哪些？各自的作用是什么？

**答案**：
- **NodeSelectorSlot**：负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级
- **ClusterBuilderSlot**：用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等，这些信息将用作为多维度限流，降级的依据
- **StatisticSlot**：用于记录、统计不同纬度的 runtime 指标监控信息
- **FlowSlot**：用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制
- **AuthoritySlot**：根据配置的黑白名单和调用来源信息，来做黑白名单控制
- **DegradeSlot**：通过统计信息以及预设的规则，来做熔断降级
- **SystemSlot**：通过系统的状态，例如 load1 等，来控制总的入口流量

### 4. Sentinel 的流控模式有哪些？各自的应用场景是什么？

**答案**：
- **直接**：统计当前资源的请求，触发阈值时对当前资源直接限流。适用于保护自身服务。
- **关联**：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流。适用于保护下游依赖服务。
- **链路**：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流。适用于精细化的流量控制。

### 5. Sentinel 的熔断策略有哪些？

**答案**：
- **慢调用比例**：当单位统计时长内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则触发熔断。适用于对响应时间敏感的场景。
- **异常比例**：当单位统计时长内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则触发熔断。适用于对错误率敏感的场景。
- **异常数**：当单位统计时长内的异常数目超过阈值之后会触发熔断。适用于对错误次数敏感的场景。

### 6. Hystrix 和 Sentinel 的区别是什么？

**答案**：
- **隔离策略**：Hystrix 支持线程池和信号量隔离，Sentinel 仅支持信号量隔离。
- **熔断策略**：Hystrix 基于错误百分比，Sentinel 支持慢调用比例、异常比例、异常数。
- **限流**：Sentinel 提供更丰富的限流规则，Hystrix 主要依赖线程池大小。
- **监控**：Sentinel 提供实时监控控制台，Hystrix 提供 Dashboard。
- **扩展性**：Sentinel 支持自定义插槽，Hystrix 扩展性较差。
- **性能**：Sentinel 性能优于 Hystrix。

### 7. 什么是分布式限流？如何实现？

**答案**：
- **分布式限流**：在分布式环境下，对整个集群的流量进行控制，而不是单个实例。
- **实现方式**：
  1. **中心化**：使用 Redis、ZooKeeper 等中间件存储限流计数
  2. **令牌桶**：使用 Redis 实现分布式令牌桶
  3. **集群流控服务**：独立部署流控服务，计算集群总流量并分发配额

### 8. 如何选择合适的熔断降级框架？

**答案**：
- **Sentinel**：适合需要高性能、丰富限流规则、实时监控的场景，特别是阿里巴巴技术栈的项目。
- **Hystrix**：适合已经使用 Netflix OSS 栈的项目，但由于已进入维护模式，不建议新项目使用。
- **Resilience4j**：适合需要轻量级、函数式编程、模块化的场景，特别是 Java 8+ 项目。

## 8. 参考链接

### Sentinel
- [Sentinel 官方文档](https://sentinelguard.io/zh-cn/docs/)
- [Sentinel GitHub](https://github.com/alibaba/Sentinel)
- [Sentinel 核心类解析](https://github.com/alibaba/Sentinel/wiki/Sentinel-%E6%A0%B8%E5%BF%83%E7%B1%BB%E8%A7%A3%E6%9E%90)
- [Sentinel 分布式限流](https://sentinelguard.io/zh-cn/docs/cluster-flow-control.html)

### Hystrix
- [Hystrix 官方文档](https://github.com/Netflix/Hystrix/wiki)
- [Hystrix GitHub](https://github.com/Netflix/Hystrix)
- [Hystrix 原理解析](https://blog.csdn.net/csdn_tiger1993/article/details/122974050)

### Resilience4j
- [Resilience4j 官方文档](https://resilience4j.readme.io/docs/)
- [Resilience4j GitHub](https://github.com/resilience4j/resilience4j)
- [Resilience4j 概要](https://www.saoniuhuo.com/article/detail-482538.html)

### 限流算法
- [限流算法详解](https://zhuanlan.zhihu.com/p/479956069)
- [分布式限流方案](https://www.codetd.com/article/14268671)

### 对比分析
- [Sentinel、Hystrix、Resilience4j 对比](https://blog.csdn.net/lizz861109/article/details/103581742)
- [Sentinel 与 Hystrix 对比](https://blog.csdn.net/pastxu/article/details/124531980)